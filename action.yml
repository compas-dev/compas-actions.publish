name: 'compas-actions.publish'
description: 'Publish COMPAS or its plugins to PYPI'

inputs:
  github_token:
    description: 'The Github token'
    required: true
  publish_to_pypi:
    description: 'Whether to publish to PYPI'
    required: false
    default: 'true'
  pypi_token:
    description: 'the PYPI account token'
    required: false
    default: ''
  build_ghpython_components:
    description: 'Whether to build gh_python components'
    required: false
    default: 'false'
  create_release:
    description: 'Whether to create a release on the repo'
    required: false
    default: 'true'
  python:
    description: "which python version to build with"
    required: false
    default: "3.10"

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3

    - name: Get Version From Tag
      id: tag_name
      run: |
        echo "current_version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Get Changelog Entry
      if: inputs.create_release == 'true'
      id: changelog_reader
      uses: mindsers/changelog-reader-action@v2
      with:
        version: ${{ steps.tag_name.outputs.current_version }}
        path: ./CHANGELOG.md
    
    - name: Create Release
      if: inputs.create_release == 'true'
      id: create_release
      uses: ncipollo/release-action@v1
      with:
        body: ${{ steps.changelog_reader.outputs.changes }}
        token: ${{ inputs.github_token }}

    - if: inputs.build_ghpython_components == 'true'
      uses: compas-dev/compas-actions.build@v3
      with:
        invoke_lint: true
        check_import: true
        build_ghpython_components: true
        python: ${{ inputs.python }}
      
    - if: inputs.build_ghpython_components == 'false'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python }}

    - shell: bash
      if: inputs.publish_to_pypi == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel twine
        python setup.py clean --all sdist bdist_wheel
        twine check dist/*
        twine upload dist/* --skip-existing
      env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ inputs.pypi_token }}
